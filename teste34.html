<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Filamento a partir de SVG</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Wrapper para preview com cotas arquitetônicas */
    #canvas-wrapper {
      background: white;
      position: relative;
      padding: 40px;
      box-sizing: border-box;
    }
    /* Cotas externas */
    .wrapper-cota-h {
      position: absolute;
      border-top: 2px solid black;
      pointer-events: none;
    }
    .wrapper-cota-v {
      position: absolute;
      border-left: 2px solid black;
      pointer-events: none;
    }
    /* Labels externas */
    .wrapper-label-h,
    .wrapper-label-v {
      position: absolute;
      background: white;
      padding: 2px 4px;
      font-size: 0.875rem;
      color: #4A5568;
      font-weight: 500;
      pointer-events: none;
    }
    .wrapper-label-h { transform: translateX(-50%); }
    .wrapper-label-v { transform: translateY(-50%) rotate(-90deg); }
    /* SVG interno */
    #canvas-container svg path,
    #canvas-container svg polygon {
      fill: black !important;
      stroke: none !important;
    }
    /* Estimativas */
    .estimativa-label {
      color: #DD6B20;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-4xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Parâmetros de Impressão -->
    <div class="bg-white shadow rounded-lg p-6 space-y-4">
      <h1 class="text-xl font-semibold">Parâmetros de Impressão</h1>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Arquivo SVG</span>
        <input type="file" id="svgFile" accept=".svg" class="mt-1 block w-full text-sm text-gray-600" />
      </label>
      <fieldset class="grid grid-cols-3 gap-2 border border-gray-200 p-4 rounded">
        <legend class="text-sm font-medium text-gray-700">Altura da peça (Z, mm)</legend>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="10" class="form-radio" checked><span class="ml-2">10</span></label>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="20" class="form-radio"><span class="ml-2">20</span></label>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="30" class="form-radio"><span class="ml-2">30</span></label>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="40" class="form-radio"><span class="ml-2">40</span></label>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="50" class="form-radio"><span class="ml-2">50</span></label>
        <label class="inline-flex items-center"><input type="radio" name="alturaPeca" value="60" class="form-radio"><span class="ml-2">60</span></label>
      </fieldset>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Largura do extrusor (mm)</span>
        <input type="number" id="extrusorWidth" value="1.2" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">N° de perímetros (shells)</span>
        <input type="number" id="numPerimetros" value="2" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Espessura do fundo (mm)</span>
        <input type="number" id="espessuraFundo" value="0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Diâmetro do filamento (mm)</span>
        <input type="number" id="diametro" value="1.75" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Densidade (g/cm³)</span>
        <input type="number" id="densidade" value="1.27" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Preço por kg (R$)</span>
        <input type="number" id="precoKg" value="90" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
      </label>
      <button onclick="calcularConsumo()" class="mt-4 w-full py-2 bg-blue-600 text-white font-semibold rounded">Calcular Consumo</button>
    </div>
    <!-- Preview SVG com cotas externas e internas -->
    <div id="canvas-wrapper" class="shadow rounded-lg overflow-hidden">
      <!-- Cotas externas -->
      <div class="wrapper-cota-h"></div>
      <div class="wrapper-cota-v"></div>
      <div id="canvas-container"></div>
      <div id="wrapper-label-w" class="wrapper-label-h"></div>
      <div id="wrapper-label-h" class="wrapper-label-v"></div>
    </div>
    <!-- Resultados -->
    <div id="resultado" class="lg:col-span-2 bg-white shadow rounded-lg p-6 space-y-2 text-gray-900"></div>
  </div>
  <canvas id="canvas" class="hidden"></canvas>
  <script>
    const layerHeight = 0.55;
    let svgElement, areaReal = 0, perimeter = 0, estimate = 1;

    document.getElementById('svgFile').addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        document.getElementById('canvas-container').innerHTML = ev.target.result;
        setTimeout(processSVG, 100);
      };
      reader.readAsText(file);
    });

    function processSVG() {
      svgElement = document.querySelector('#canvas-container svg');
      const rawW = parseFloat(svgElement.getAttribute('width')) || 0;
      const vb = svgElement.getAttribute('viewBox').split(' ').map(Number);
      const scale = rawW && vb[2] ? rawW / vb[2] : 1;
      svgElement.removeAttribute('width'); svgElement.removeAttribute('height');

      // bounding box do SVG
      const bbox = svgElement.getBBox();
      const wrapper = document.getElementById('canvas-wrapper');
      const svgRect = svgElement.getBoundingClientRect();
      const wrapRect = wrapper.getBoundingClientRect();
      const offX = svgRect.left - wrapRect.left;
      const offY = svgRect.top - wrapRect.top;
      const wPx = svgRect.width;
      const hPx = svgRect.height;

      // cotas externas
      const cmW = (bbox.width * scale / 10).toFixed(2) + ' cm';
      const cmH = (bbox.height * scale / 10).toFixed(2) + ' cm';
      const exH = wrapper.querySelector('.wrapper-cota-h');
      exH.style.left = offX + 'px'; exH.style.top = offY + 'px'; exH.style.width = wPx + 'px';
      const exV = wrapper.querySelector('.wrapper-cota-v');
      exV.style.left = offX + 'px'; exV.style.top = offY + 'px'; exV.style.height = hPx + 'px';
      const lblW = document.getElementById('wrapper-label-w');
      lblW.innerText = cmW; lblW.style.left = (offX + wPx/2) + 'px'; lblW.style.top = (offY - 20) + 'px';
      const lblH = document.getElementById('wrapper-label-h');
      lblH.innerText = cmH; lblH.style.left = (offX - 20) + 'px'; lblH.style.top = (offY + hPx/2) + 'px';

      // cotas internas
      const ns = 'http://www.w3.org/2000/svg';
      svgElement.querySelectorAll('.cota-line, .cota-text').forEach(el => el.remove());
      // horizontal interna
      const lH = document.createElementNS(ns, 'line');
      lH.setAttribute('class', 'cota-line');
      lH.setAttribute('x1', bbox.x); lH.setAttribute('y1', bbox.y);
      lH.setAttribute('x2', bbox.x + bbox.width); lH.setAttribute('y2', bbox.y);
      lH.setAttribute('stroke', 'black'); lH.setAttribute('stroke-width', '0.2');
      svgElement.appendChild(lH);
      // vertical interna
      const lV = document.createElementNS(ns, 'line');
      lV.setAttribute('class', 'cota-line');
      lV.setAttribute('x1', bbox.x); lV.setAttribute('y1', bbox.y);
      lV.setAttribute('x2', bbox.x); lV.setAttribute('y2', bbox.y + bbox.height);
      lV.setAttribute('stroke', 'black'); lV.setAttribute('stroke-width', '0.2');
      svgElement.appendChild(lV);
      // texto interno W
      const tW = document.createElementNS(ns, 'text');
      tW.setAttribute('class', 'cota-text'); tW.setAttribute('x', bbox.x + bbox.width/2);
      tW.setAttribute('y', bbox.y - 0.5); tW.setAttribute('fill', '#4A5568');
      tW.setAttribute('font-size', '0.5'); tW.setAttribute('text-anchor', 'middle');
      tW.textContent = cmW; svgElement.appendChild(tW);
      // texto interno H
      const tH = document.createElementNS(ns, 'text');
      tH.setAttribute('class', 'cota-text'); tH.setAttribute('x', bbox.x - 0.5);
      tH.setAttribute('y', bbox.y + bbox.height/2); tH.setAttribute('fill', '#4A5568');
      tH.setAttribute('font-size', '0.5'); tH.setAttribute('text-anchor', 'middle');
      tH.setAttribute('transform', `rotate(-90,${bbox.x-0.5},${bbox.y+bbox.height/2})`);
      tH.textContent = cmH; svgElement.appendChild(tH);

      // perímetro
      perimeter = 0; svgElement.querySelectorAll('path').forEach(p => perimeter += p.getTotalLength()*scale);
      svgElement.querySelectorAll('polygon').forEach(poly => {
        const pts = poly.getAttribute('points').trim().split(/\s+/).map(pt => pt.split(',').map(Number));
        let s=0; pts.forEach((pt,i)=>{ const[x1,y1]=pt,[x2,y2]=pts[(i+1)%pts.length]; s+=Math.hypot(x2-x1,y2-y1);} ); perimeter += s*scale;
      });

      // área via canvas
      const areaTotal = bbox.width * bbox.height * scale * scale;
      const cnv = document.getElementById('canvas'), ctx = cnv.getContext('2d');
      const res = 2000; cnv.width = res; cnv.height = Math.round(res * bbox.height / bbox.width);
      ctx.clearRect(0,0,res,cnv.height);
      const clone = svgElement.cloneNode(true);
      clone.removeAttribute('style'); clone.querySelectorAll('defs, style').forEach(e=>e.remove());
      clone.setAttribute('viewBox', svgElement.getAttribute('viewBox'));
      clone.setAttribute('width', res); clone.setAttribute('height', cnv.height);
      clone.setAttribute('fill-rule', 'evenodd');
      clone.querySelectorAll('path, polygon').forEach(el=>{ el.removeAttribute('class'); el.setAttribute('fill', '#000'); el.removeAttribute('stroke'); });
      const blob = new Blob([new XMLSerializer().serializeToString(clone)], { type: 'image/svg+xml' });
      const img = new Image(); img.onload = () => {
        ctx.drawImage(img, 0, 0, res, cnv.height); URL.revokeObjectURL(img.src);
        const data = ctx.getImageData(0,0,res,cnv.height).data;
        let cnt = 0; for(let i=3;i<data.length;i+=4) if(data[i]>0) cnt++;
        areaReal = areaTotal * (cnt/(res*cnv.height));
        document.getElementById('resultado').innerHTML =
          `<p class="estimativa-label">Estimativa ${estimate}</p>`+
          `<p><strong>Perímetro:</strong> ${perimeter.toFixed(2)} mm</p>`+
          `<p><strong>Área:</strong> ${areaReal.toFixed(3)} mm²</p>`;
        estimate++;
      };
      img.src = URL.createObjectURL(blob);
    }

    function calcularConsumo() {
      if (!svgElement || areaReal <= 0) return alert('Envie e processe o SVG primeiro.');
      const altura = +document.querySelector('input[name="alturaPeca"]:checked').value;
      const ext = +document.getElementById('extrusorWidth').value;
      const shells = +document.getElementById('numPerimetros').value;
      const fundo = +document.getElementById('espessuraFundo').value;
      const dia = +document.getElementById('diametro').value;
      const dens = +document.getElementById('densidade').value;
      const prec = +document.getElementById('precoKg').value;
      const layers = Math.ceil(fundo / layerHeight);
      const volF = areaReal * layers * layerHeight;
      const volP = perimeter * ext * altura * shells;
      const volT = volF + volP;
      const areaFil = Math.PI * (dia/2)**2;
      const compr = volT / areaFil / 1000;
      const peso = volT/1000 * dens;
      const custo = peso/1000 * prec;
      document.getElementById('resultado').innerHTML +=
        `<p class="estimativa-label">Estimativa ${estimate}</p>`+
        `<p><strong>Volume fundo:</strong> ${volF.toFixed(2)} mm³</p>`+
        `<p><strong>Volume paredes:</strong> ${volP.toFixed(2)} mm³</p>`+
        `<p><strong>Total:</strong> ${volT.toFixed(2)} mm³</p>`+
        `<p><strong>Comprimento:</strong> ${compr.toFixed(2)} m</p>`+
        `<p><strong>Peso:</strong> ${peso.toFixed(2)} g</p>`+
        `<p><strong>Custo:</strong> R$ ${custo.toFixed(2)}</p>`;
      estimate++;
    }
  </script>
</body>
</html>
